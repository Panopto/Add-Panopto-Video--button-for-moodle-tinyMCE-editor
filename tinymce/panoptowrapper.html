<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <script src="js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="js/tiny_mce_popup.js"></script>

    <script>
        //Replace servername (inside quotations) with target panoptoservername
        var servername = 'http://demo.hosted.panopto.com';

        //set filepath for panopto id grabber function
        var filepath = tinyMCEPopup.getWindowArg('filepath') + 'panoptobutton/grabber.php';

        $(document).ready(function () {

            //Setup for message handling from iframe
            var eventMethod = window.addEventListener ? "addEventListener" : "attachEvent";
            var eventEnter = window[eventMethod];
            var messageEvent = eventMethod === "attachEvent" ? "onmessage" : "message";

            //default panopto id is blank
            var panoptoID = "";

            //set panopto ID string to value returned from grabber
            //(string returned will contain '?id=' if an id exists, and will be blank if it does not)
            $.get(filepath, function (data) {
                panoptoID = data;
            });

            $('#pageframe').attr('src', servername + "/Panopto/Pages/Sessions/EmbeddedUpload.aspx" + panoptoID);
            //Hide insert button initially, until a video is selected
            $("#insert").hide();

            // Listen to message from child iframe
            eventEnter(messageEvent, function (e) {

                var message = JSON.parse(e.data);

                //If a video is chosen, show the "Insert" button
                if (message.cmd === 'ready') {
                    $("#insert").show();
                }

                //If no video is chosen, hide the "Insert" button
                if (message.cmd === 'notReady') {
                    $("#insert").hide();
                }

                //Called when "Insert" is clicked. Creates HTML for embedding each selected video into the editor
                if (message.cmd === 'deliveryList') {

                    $.each(message.ids, function (key, value) {
                        var iframeString = "<iframe src=\"" + servername + "/Panopto/Pages/Embed.aspx?id=" + value + "&v=1\" width=\"450\" height=\"300\" frameborder=\"0\"></iframe><br>";
                        window.parent.tinyMCE.activeEditor.execCommand('mceInsertContent', 0, iframeString);
                    });

                    tinyMCEPopup.close();
                }
            }, false);

            $("#insert").click(function () {
                var win = document.getElementById("pageframe").contentWindow,
                message = { cmd: "createEmbeddedFrame" };
                win.postMessage(JSON.stringify(message), servername);
            });

            $("#cancel").click(function () {
                tinyMCEPopup.close();
            });
        });
    </script>

    <meta charset="utf-8" />
    <title>Add Panopto Video</title>
</head>
<body>
    <div id='pagediv'>
        <iframe id="pageframe" width="990" height="680"></iframe>
    </div>

    <button id="insert">Insert</button>
    <button id="cancel">Cancel</button>
</body>
</html>